name: Validate Config

on:
  pull_request:
    branches: [ main ]

jobs:
  exist:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        key:
          - package.name
          - package.version
          - package.authors
          - package.edition
          - package.repository
          - package.description
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: actions-rs/install@v0.1
        with:
          crate: toml-cli

      - run: |
          find . -name '*.toml' -type f | \
          xargs -I {} bash -c \
          'test "$(toml get {} ${{ matrix.key }})" != "null"'

  valid_authors:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: actions-rs/install@v0.1
        with:
          crate: toml-cli

      - run: |
          find . -name '*.toml' -type f | \
          xargs -I {} bash -c \
          'test "$(toml get {} package.authors)" != "[]"'

  valid_edition:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: actions-rs/install@v0.1
        with:
          crate: toml-cli

      - run: |
          find . -name '*.toml' -type f | \
          xargs -I {} bash -c \
          '[[ "$(toml get {} package.edition)" =~ ^1998|2003|2011|2014|2017|2020$ ]]'

  valid_repository:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: actions-rs/install@v0.1
        with:
          crate: toml-cli

      - run: |
          find . -name '*.toml' -type f | \
          xargs -I {} bash -c \
          '[[ "$(toml get {} package.repository)" =~ ^\"https:\/\/github\.com\/.*\/tree\/.*\"$ ]]'

  version_eq_filename:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: actions-rs/install@v0.1
        with:
          crate: toml-cli

      - run: |
          find . -name '*.toml' -type f | \
          xargs -I {} bash -c \
          'test "`echo $(toml get {} package.version) | tr -d '\''\"'\''`.toml" = "$(basename {})"'
        working-directory: manifests

  misleading:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v14.3

      - name: Pick the first change  # FIXME: all changed files
        id: added-file
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "::set-output name=name::$file"
            break
          done

      - name: Check added file is *.toml
        id: toml-file-check
        run: |
          echo "::set-output name=result::$([[ '${{ steps.added-file.outputs.name }}' =~ \.toml$ ]] && echo 'true' || echo 'false')"

      - uses: actions-rs/install@v0.1
        if: steps.toml-file-check.outputs.result == 'true'
        with:
          crate: toml-cli

      - name: Get changed file name
        if: steps.toml-file-check.outputs.result == 'true'
        id: added-package
        run: echo "::set-output name=name::$(toml get ${{ steps.added-file.outputs.name }} package.name)"

      - name: List package names
        if: steps.toml-file-check.outputs.result == 'true'
        id: existent-packages
        run: |
          LIST=''
          find . -name '*.toml' -type f | \
          xargs -I {} bash -c \
          'LIST="$LIST $(toml get {} package.name)"'
          echo "::set-output name=list::${LIST//${{ steps.added-package.outputs.name }}/}"

      - uses: ken-matsui/misleading-name-check@v1
        id: check-misleading
        if: steps.toml-file-check.outputs.result == 'true'
        with:
          name: ${{ steps.added-package.outputs.name }}
          list: ${{ steps.existent-packages.outputs.list }}

      - name: Test the result
        if: steps.toml-file-check.outputs.result == 'true'
        run: |
          [ '${{ steps.check-misleading.outputs.is-misleading }}' = 'false' ]
